name: Agent Runtime - Investigate & Act

# This workflow implements the GitHub Actions agent runtime pattern:
# Investigate (read-only) â†’ Approve (gate) â†’ Act (elevated permissions)
#
# Design principles:
# - Ephemeral compute (GitHub-hosted runners)
# - Explicit permission boundaries (job-level)
# - Complete audit trail (AIMgentix integration)
# - Human approval gates (environment protection)
#
# Spec: specs/github-actions-agent-runtime.md

on:
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'Trigger source (manual/alert/schedule)'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - alert
          - schedule
      trace_id:
        description: 'Unique trace ID for audit correlation'
        required: true
        type: string
      resource:
        description: 'Target resource to investigate/act on'
        required: true
        type: string
      action_context:
        description: 'Additional context (JSON string, optional)'
        required: false
        type: string
        default: '{}'

jobs:
  # JOB 1: INVESTIGATE (Read-Only)
  # Purpose: Analyze situation without making changes
  # Permissions: Minimal (contents: read only)
  investigate:
    name: Investigate (Read-Only)
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Read-only - cannot modify anything
    
    outputs:
      recommendation: ${{ steps.analyze.outputs.recommendation }}
      safe_to_proceed: ${{ steps.analyze.outputs.safe_to_proceed }}
      confidence_score: ${{ steps.analyze.outputs.confidence_score }}
      investigation_summary: ${{ steps.analyze.outputs.investigation_summary }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install AIMgentix SDK
        run: |
          cd sdk
          pip install -e .
      
      - name: Initialize Audit Trail
        id: audit-init
        run: |
          echo "trace_id=${{ inputs.trace_id }}" >> $GITHUB_OUTPUT
          echo "agent_instance_id=gh-actions-${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Audit Trail Initialized"
          echo "  Trace ID: ${{ inputs.trace_id }}"
          echo "  Agent Instance: gh-actions-${{ github.run_id }}"
          echo "  Resource: ${{ inputs.resource }}"
      
      - name: Run Investigation Agent
        id: analyze
        env:
          TRACE_ID: ${{ inputs.trace_id }}
          AGENT_INSTANCE_ID: gh-actions-${{ github.run_id }}
          TARGET_RESOURCE: ${{ inputs.resource }}
          ACTION_CONTEXT: ${{ inputs.action_context }}
          TRIGGER_SOURCE: ${{ inputs.trigger_source }}
        run: |
          # Create investigation script
          cat > /tmp/investigate.py << 'EOF'
          import os
          import json
          import sys
          from datetime import datetime
          
          # Simulate investigation logic
          trace_id = os.getenv('TRACE_ID')
          agent_id = os.getenv('AGENT_INSTANCE_ID')
          resource = os.getenv('TARGET_RESOURCE')
          context = json.loads(os.getenv('ACTION_CONTEXT', '{}'))
          
          print(f"ðŸ” Investigation Started")
          print(f"  Resource: {resource}")
          print(f"  Context: {json.dumps(context, indent=2)}")
          
          # Simulate analysis
          findings = {
              "timestamp": datetime.utcnow().isoformat() + "Z",
              "resource": resource,
              "status": "analyzed",
              "risk_level": "low",
              "issues_found": [],
              "recommendation": "safe_to_restart",
              "confidence": 0.95,
              "analysis": {
                  "resource_exists": True,
                  "last_modified": "2026-02-01T12:00:00Z",
                  "dependencies_healthy": True,
                  "error_rate": 0.0
              }
          }
          
          # Determine if safe to proceed
          safe_to_proceed = findings['risk_level'] in ['low', 'medium'] and findings['confidence'] > 0.7
          
          print(f"âœ… Investigation Complete")
          print(f"  Risk Level: {findings['risk_level']}")
          print(f"  Confidence: {findings['confidence']}")
          print(f"  Safe to Proceed: {safe_to_proceed}")
          
          # Output for GitHub Actions
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
              f.write(f"recommendation={findings['recommendation']}\n")
              f.write(f"safe_to_proceed={'true' if safe_to_proceed else 'false'}\n")
              f.write(f"confidence_score={findings['confidence']}\n")
              f.write(f"investigation_summary={findings['risk_level']} risk, {findings['confidence']*100:.0f}% confident\n")
          
          # Save full report
          with open('investigation-report.json', 'w') as f:
              json.dump(findings, f, indent=2)
          
          print(f"ðŸ“„ Investigation report saved")
          EOF
          
          python /tmp/investigate.py
      
      - name: Upload Investigation Report
        uses: actions/upload-artifact@v4
        with:
          name: investigation-report
          path: investigation-report.json
          retention-days: 30
      
      - name: Save Trace ID Artifact
        run: |
          echo "${{ inputs.trace_id }}" > audit-trace-id.txt
          echo "Resource: ${{ inputs.resource }}" >> audit-trace-id.txt
          echo "Run ID: ${{ github.run_id }}" >> audit-trace-id.txt
      
      - name: Upload Trace ID
        uses: actions/upload-artifact@v4
        with:
          name: audit-trace-id
          path: audit-trace-id.txt
          retention-days: 90

  # JOB 2: APPROVE (Human Gate)
  # Purpose: Review investigation and approve/reject action
  # Permissions: None (approval only)
  approve:
    name: Approve Action
    needs: investigate
    runs-on: ubuntu-latest
    environment:
      name: agent-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Display Investigation Results
        run: |
          echo "## ðŸ” Investigation Results"
          echo ""
          echo "**Recommendation**: ${{ needs.investigate.outputs.recommendation }}"
          echo "**Safe to Proceed**: ${{ needs.investigate.outputs.safe_to_proceed }}"
          echo "**Confidence Score**: ${{ needs.investigate.outputs.confidence_score }}"
          echo "**Summary**: ${{ needs.investigate.outputs.investigation_summary }}"
          echo ""
          echo "---"
          echo ""
          echo "**Resource**: ${{ inputs.resource }}"
          echo "**Trace ID**: ${{ inputs.trace_id }}"
          echo "**Trigger**: ${{ inputs.trigger_source }}"
          echo ""
          echo "âš ï¸  **Review the investigation report before approving**"
          echo "ðŸ“Š Download artifacts from the investigate job to see full details"
      
      - name: Check Auto-Approval Criteria
        id: auto-approve-check
        run: |
          # Auto-approve only if confidence is very high and risk is very low
          SAFE="${{ needs.investigate.outputs.safe_to_proceed }}"
          CONFIDENCE="${{ needs.investigate.outputs.confidence_score }}"
          
          if [ "$SAFE" = "true" ] && [ "$(echo "$CONFIDENCE > 0.95" | bc)" -eq 1 ]; then
            echo "auto_approved=true" >> $GITHUB_OUTPUT
            echo "âœ… Auto-approval criteria met (confidence > 95%)"
          else
            echo "auto_approved=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Manual approval required"
          fi

  # JOB 3: ACT (Elevated Permissions)
  # Purpose: Execute the approved action
  # Permissions: Scoped write access
  act:
    name: Execute Action
    needs: [investigate, approve]
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Elevated - can make changes
      issues: write    # Can update issues if needed
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install AIMgentix SDK
        run: |
          cd sdk
          pip install -e .
      
      - name: Download Investigation Report
        uses: actions/download-artifact@v4
        with:
          name: investigation-report
      
      - name: Execute Approved Action
        id: execute
        env:
          TRACE_ID: ${{ inputs.trace_id }}
          AGENT_INSTANCE_ID: gh-actions-${{ github.run_id }}
          TARGET_RESOURCE: ${{ inputs.resource }}
          RECOMMENDATION: ${{ needs.investigate.outputs.recommendation }}
        run: |
          # Create action execution script
          cat > /tmp/execute_action.py << 'EOF'
          import os
          import json
          import time
          from datetime import datetime
          
          trace_id = os.getenv('TRACE_ID')
          agent_id = os.getenv('AGENT_INSTANCE_ID')
          resource = os.getenv('TARGET_RESOURCE')
          recommendation = os.getenv('RECOMMENDATION')
          
          print(f"ðŸš€ Action Execution Started")
          print(f"  Resource: {resource}")
          print(f"  Recommendation: {recommendation}")
          
          start_time = time.time()
          
          # Simulate action execution
          # In a real scenario, this would:
          # - Restart a service
          # - Deploy a fix
          # - Update configuration
          # - Execute remediation
          
          time.sleep(2)  # Simulate work
          
          latency_ms = int((time.time() - start_time) * 1000)
          
          result = {
              "timestamp": datetime.utcnow().isoformat() + "Z",
              "resource": resource,
              "action": recommendation,
              "status": "success",
              "latency_ms": latency_ms,
              "details": {
                  "action_type": "service_restart",
                  "affected_resources": [resource],
                  "rollback_available": True
              }
          }
          
          print(f"âœ… Action Completed Successfully")
          print(f"  Latency: {latency_ms}ms")
          print(f"  Status: {result['status']}")
          
          # Output for GitHub Actions
          with open(os.getenv('GITHUB_OUTPUT'), 'a') as f:
              f.write(f"status={result['status']}\n")
              f.write(f"latency_ms={latency_ms}\n")
          
          # Save action result
          with open('action-result.json', 'w') as f:
              json.dump(result, f, indent=2)
          
          print(f"ðŸ“„ Action result saved")
          EOF
          
          python /tmp/execute_action.py
      
      - name: Upload Action Result
        uses: actions/upload-artifact@v4
        with:
          name: action-result
          path: action-result.json
          retention-days: 30
      
      - name: Create Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸŽ¯ Agent Action Complete
          
          ## Investigation Phase
          - **Resource**: ${{ inputs.resource }}
          - **Recommendation**: ${{ needs.investigate.outputs.recommendation }}
          - **Confidence**: ${{ needs.investigate.outputs.confidence_score }}
          
          ## Execution Phase  
          - **Status**: ${{ steps.execute.outputs.status }}
          - **Latency**: ${{ steps.execute.outputs.latency_ms }}ms
          
          ## Audit Trail
          - **Trace ID**: ${{ inputs.trace_id }}
          - **Agent Instance**: gh-actions-${{ github.run_id }}
          - **Trigger**: ${{ inputs.trigger_source }}
          
          ---
          
          âœ… **Complete audit trail available via AIMgentix**
          
          View artifacts for detailed reports.
          EOF

  # JOB 4: SUMMARIZE (Always runs)
  # Purpose: Create final summary regardless of success/failure
  summarize:
    name: Summarize Workflow
    needs: [investigate, approve, act]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Workflow Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Agent Workflow Summary
          
          ## Workflow Details
          - **Run ID**: ${{ github.run_id }}
          - **Trace ID**: ${{ inputs.trace_id }}
          - **Resource**: ${{ inputs.resource }}
          - **Trigger**: ${{ inputs.trigger_source }}
          
          ## Job Status
          - **Investigate**: ${{ needs.investigate.result }}
          - **Approve**: ${{ needs.approve.result }}
          - **Act**: ${{ needs.act.result }}
          
          ## Investigation Results
          - **Recommendation**: ${{ needs.investigate.outputs.recommendation }}
          - **Safe to Proceed**: ${{ needs.investigate.outputs.safe_to_proceed }}
          - **Summary**: ${{ needs.investigate.outputs.investigation_summary }}
          
          ## Artifacts
          All workflow artifacts are available for 30 days:
          - Investigation report
          - Action result (if executed)
          - Audit trace ID
          
          ---
          
          **Audit Trail**: All events logged to AIMgentix with trace ID \`${{ inputs.trace_id }}\`
          EOF
      
      - name: Generate Machine-Readable Summary
        run: |
          cat > workflow-summary.json << EOF
          {
            "workflow_run_id": "${{ github.run_id }}",
            "trace_id": "${{ inputs.trace_id }}",
            "resource": "${{ inputs.resource }}",
            "trigger_source": "${{ inputs.trigger_source }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "results": {
              "investigate": "${{ needs.investigate.result }}",
              "approve": "${{ needs.approve.result }}",
              "act": "${{ needs.act.result }}"
            },
            "investigation": {
              "recommendation": "${{ needs.investigate.outputs.recommendation }}",
              "safe_to_proceed": "${{ needs.investigate.outputs.safe_to_proceed }}",
              "summary": "${{ needs.investigate.outputs.investigation_summary }}"
            }
          }
          EOF
          
          cat workflow-summary.json
      
      - name: Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: workflow-summary
          path: workflow-summary.json
          retention-days: 90

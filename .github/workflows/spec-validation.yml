name: Spec Validation

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  check-spec-drift:
    name: Check Spec Drift
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to compare changes
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          backend/app/models.py
          sdk/aimgentix/events.py
          .github/workflows/**
    
    - name: Check if specs were updated
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "Contract-bearing files changed:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Check if any spec files were also changed
        SPEC_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^specs/.*\.md$' || true)
        
        if [ -z "$SPEC_CHANGED" ]; then
          echo "❌ ERROR: Contract-bearing files changed but no specs updated"
          echo ""
          echo "Files changed:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo ""
          echo "Required action:"
          echo "- If you changed event schema (models.py, events.py): update specs/event-schema.md"
          echo "- If you changed workflow contracts: update or create a spec"
          echo "- If this is a non-breaking internal change, add label 'internal-only' to bypass"
          echo ""
          echo "See specs/SPEC_POLICY.md for guidance"
          exit 1
        else
          echo "✅ Specs updated: $SPEC_CHANGED"
        fi
    
    - name: Allow bypass with label
      if: failure() && contains(github.event.pull_request.labels.*.name, 'internal-only')
      run: |
        echo "⚠️  Bypassing spec check due to 'internal-only' label"
        exit 0

  run-contract-tests:
    name: Run Contract Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install backend dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Run backend contract tests
      working-directory: backend
      run: |
        pytest tests/test_contracts.py -v
    
    - name: Install SDK
      working-directory: sdk
      run: |
        pip install -e .
        pip install pytest
    
    - name: Run SDK contract tests
      working-directory: sdk
      run: |
        pytest tests/test_contracts.py -v


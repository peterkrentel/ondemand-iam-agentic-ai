name: Spec Validation

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  check-spec-drift:
    name: Check Spec Drift
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to compare changes

    # NOTE: Workflow changes are NOT monitored here to avoid false positives
    # (action version bumps, formatting, step renames don't need spec updates).
    # If you add workflow inputs/outputs that become contracts, add them manually.
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          backend/app/models.py
          sdk/aimgentix/events.py

    - name: Check for schema-affecting changes
      if: steps.changed-files.outputs.any_changed == 'true'
      id: schema-check
      run: |
        echo "Contract-bearing files changed:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"

        # Check if changes are only whitespace/comments (allow these without spec update)
        REAL_CHANGES=false
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          # Check if there are non-whitespace changes
          if git diff origin/${{ github.base_ref }}...HEAD -- "$file" | grep -E '^\+[^+\s]|^-[^-\s]' > /dev/null; then
            REAL_CHANGES=true
            break
          fi
        done

        if [ "$REAL_CHANGES" = "false" ]; then
          echo "✅ Only whitespace/comment changes detected - no spec update required"
          exit 0
        fi

        # Check if any spec files were also changed
        SPEC_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^specs/.*\.md$' || true)

        if [ -z "$SPEC_CHANGED" ]; then
          echo "schema_changed=true" >> $GITHUB_OUTPUT
          echo "❌ ERROR: Contract-bearing files changed but no specs updated"
          echo ""
          echo "Files changed:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo ""
          echo "Required action:"
          echo "- If you changed event schema (models.py, events.py): update specs/event-schema.md"
          echo "- If this is a non-breaking internal change: add label 'internal-only' AND explain in PR description"
          echo ""
          echo "See specs/SPEC_POLICY.md for guidance"
          exit 1
        else
          echo "✅ Specs updated: $SPEC_CHANGED"
        fi

    - name: Check bypass label has justification
      if: failure() && contains(github.event.pull_request.labels.*.name, 'internal-only')
      run: |
        # Check if PR description contains justification
        PR_BODY="${{ github.event.pull_request.body }}"

        if echo "$PR_BODY" | grep -iE 'internal.only|internal change|no schema change|refactor' > /dev/null; then
          echo "✅ Bypass approved: 'internal-only' label with justification in PR description"
          exit 0
        else
          echo "❌ ERROR: 'internal-only' label requires justification in PR description"
          echo ""
          echo "Add a line to your PR description explaining why this is internal-only, e.g.:"
          echo "- 'Internal-only: refactoring without schema changes'"
          echo "- 'Internal-only: renaming internal variables'"
          echo "- 'No schema change: only added comments'"
          exit 1
        fi

  run-contract-tests:
    name: Run Contract Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install backend dependencies
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx
    
    - name: Run backend contract tests
      working-directory: backend
      run: |
        pytest tests/test_contracts.py -v
    
    - name: Install SDK
      working-directory: sdk
      run: |
        pip install -e .
        pip install pytest
    
    - name: Run SDK contract tests
      working-directory: sdk
      run: |
        pytest tests/test_contracts.py -v


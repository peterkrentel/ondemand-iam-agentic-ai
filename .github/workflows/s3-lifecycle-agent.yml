# S3 Lifecycle Demo Agent Workflow
# Demonstrates: investigate â†’ approve â†’ act pattern
# See: specs/gha-agent-runtime.md

name: S3 Lifecycle Agent

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'investigate-and-act'
        type: choice
        options:
          - investigate-only
          - investigate-and-act
          - cleanup

jobs:
  # ============================================================
  # INVESTIGATE: Read-only analysis, proposes action
  # ============================================================
  investigate:
    name: ðŸ” Investigate
    runs-on: ubuntu-latest
    if: inputs.action != 'cleanup'
    
    # READ-ONLY permissions - cannot modify anything
    permissions:
      contents: read
      id-token: write  # For AWS OIDC
    
    outputs:
      risk_level: ${{ steps.analyze.outputs.risk_level }}
      proposed_action: ${{ steps.analyze.outputs.proposed_action }}
      findings_summary: ${{ steps.analyze.outputs.findings_summary }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3
          pip install -e sdk/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
      
      - name: Run investigation
        id: analyze
        run: python agents/s3-lifecycle/agent.py investigate
        env:
          AIMGENTIX_API_URL: ${{ secrets.AIMGENTIX_API_URL }}
      
      - name: Upload findings artifact
        uses: actions/upload-artifact@v4
        with:
          name: findings
          path: findings.json
          retention-days: 30
      
      - name: Summary
        run: |
          echo "## ðŸ” Investigation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Risk Level:** ${{ steps.analyze.outputs.risk_level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Findings:** ${{ steps.analyze.outputs.findings_summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Proposed Action" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.analyze.outputs.proposed_action }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # APPROVE: Gate for human review (or auto-approve for low risk)
  # ============================================================
  approve:
    name: âœ… Approve
    runs-on: ubuntu-latest
    needs: investigate
    if: inputs.action == 'investigate-and-act'
    
    # Use environment with protection rules for approval
    environment: 
      name: agent-approval
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Review findings
        run: |
          echo "## âœ… Approval Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Risk Level:** ${{ needs.investigate.outputs.risk_level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Proposed action has been reviewed and approved." >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # ACT: Execute the approved action (elevated permissions)
  # ============================================================
  act:
    name: ðŸš€ Act
    runs-on: ubuntu-latest
    needs: [investigate, approve]
    if: inputs.action == 'investigate-and-act'
    
    # Elevated permissions for write operations
    permissions:
      contents: read
      id-token: write  # For AWS OIDC
    
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install boto3
          pip install -e sdk/
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
      
      - name: Download findings
        uses: actions/download-artifact@v4
        with:
          name: findings
          path: findings
      
      - name: Execute action
        run: python agents/s3-lifecycle/agent.py act
        env:
          AIMGENTIX_API_URL: ${{ secrets.AIMGENTIX_API_URL }}
      
      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: results.json
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸš€ Action Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat results.json | jq '.' >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # CLEANUP: Remove demo resources (separate flow)
  # ============================================================
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    if: inputs.action == 'cleanup'

    permissions:
      contents: read
      id-token: write

    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install boto3
          pip install -e sdk/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Cleanup demo resources
        run: python agents/s3-lifecycle/agent.py cleanup
        env:
          AIMGENTIX_API_URL: ${{ secrets.AIMGENTIX_API_URL }}

